//
// Created by 范炜东 on 2018/12/13.
//

#include <fstream>
#include <string>
#include <vector>
#include <cassert>
#include <boost/serialization/map.hpp>
#include <boost/archive/binary_iarchive.hpp>
#include <boost/archive/binary_oarchive.hpp>
#include <boost/archive/archive_exception.hpp>
#include <Poco/ThreadPool.h>
#include <Poco/Exception.h>
#include <Poco/Util/Application.h>
#include "Storage.h"
#include "WorldMap.h"

namespace Lineage {

using Poco::ThreadPool;
using Poco::RangeException;
using Poco::NotImplementedException;
using Poco::DataException;
using Poco::Util::Application;

// 游戏地图坐标信息格式索引
enum MAPINFO {
    MAP_ID = 0, // 地图编号
    START_X, // 地图起始X坐标
    START_Y, // 地图起始Y坐标
    END_X, // 地图结束X坐标
    END_Y, // 地图结束Y坐标
    WIDTH, // 地图宽度
    HEIGHT // 地图高度
};

static std::string mapFilePath; // 地图瓦片文件读取路径
static const char *cacheFile = "~/.cache/world_map"; // 游戏地图信息序列化文件
static const int FILES_PER_THREAD = 10; // 单线程处理地图文件数目

// 游戏地图坐标信息
static const int MAP_INFO[][7] = {{0,     32256, 32768, 32767, 33279, 512,  512},
                                  {1,     32640, 32768, 32767, 32895, 128,  128},
                                  {2,     32640, 32768, 32831, 32895, 128,  192},
                                  {3,     32640, 32768, 32767, 32831, 64,   128},
                                  {4,     32384, 32064, 34303, 33535, 1472, 1920},
                                  {5,     32704, 32768, 32767, 32831, 64,   64},
                                  {6,     32704, 32768, 32767, 32831, 64,   64},
                                  {7,     32704, 32704, 32831, 32831, 128,  128},
                                  {8,     32704, 32704, 32831, 32831, 128,  128},
                                  {9,     32704, 32704, 32831, 32831, 128,  128},
                                  {10,    32704, 32704, 32831, 32831, 128,  128},
                                  {11,    32704, 32704, 32831, 32831, 128,  128},
                                  {12,    32704, 32704, 32831, 32831, 128,  128},
                                  {13,    32704, 32704, 32831, 32831, 128,  128},
                                  {14,    32512, 32768, 33023, 32831, 64,   512},
                                  {15,    32704, 32768, 32767, 32831, 64,   64},
                                  {16,    32704, 32768, 32767, 32831, 64,   64},
                                  {17,    32704, 32768, 32767, 32831, 64,   64},
                                  {18,    32704, 32768, 32767, 32831, 64,   64},
                                  {19,    32704, 32704, 32831, 32831, 128,  128},
                                  {20,    32704, 32704, 32831, 32831, 128,  128},
                                  {21,    32704, 32704, 32831, 32831, 128,  128},
                                  {22,    32704, 32704, 32831, 32831, 128,  128},
                                  {23,    32704, 32704, 32831, 32831, 128,  128},
                                  {24,    32704, 32704, 32831, 32831, 128,  128},
                                  {25,    32704, 32704, 32831, 32831, 128,  128},
                                  {26,    32704, 32704, 32831, 32831, 128,  128},
                                  {27,    32704, 32704, 32831, 32831, 128,  128},
                                  {28,    32704, 32704, 32831, 32831, 128,  128},
                                  {29,    32704, 32768, 32767, 32831, 64,   64},
                                  {30,    32704, 32704, 32831, 32831, 128,  128},
                                  {31,    32704, 32704, 32831, 32831, 128,  128},
                                  {32,    32640, 32768, 32767, 32895, 128,  128},
                                  {33,    32640, 32768, 32767, 32895, 128,  128},
                                  {34,    32704, 32768, 32767, 32831, 64,   64},
                                  {35,    32640, 32768, 32767, 32895, 128,  128},
                                  {36,    32640, 32768, 32767, 32895, 128,  128},
                                  {37,    32640, 32768, 32767, 32895, 128,  128},
                                  {38,    32704, 32768, 32767, 32831, 64,   64},
                                  {39,    32704, 32768, 32767, 32831, 64,   64},
                                  {40,    32704, 32768, 32767, 32831, 64,   64},
                                  {41,    32704, 32768, 32767, 32831, 64,   64},
                                  {43,    32704, 32704, 32831, 32831, 128,  128},
                                  {44,    32704, 32704, 32831, 32831, 128,  128},
                                  {45,    32704, 32704, 32831, 32831, 128,  128},
                                  {46,    32704, 32704, 32831, 32831, 128,  128},
                                  {47,    32704, 32704, 32831, 32831, 128,  128},
                                  {48,    32704, 32704, 32831, 32831, 128,  128},
                                  {49,    32704, 32704, 32831, 32831, 128,  128},
                                  {50,    32704, 32704, 32831, 32831, 128,  128},
                                  {51,    32640, 32704, 32831, 32895, 192,  192},
                                  {52,    32640, 32768, 32767, 32895, 128,  128},
                                  {53,    32704, 32704, 32831, 32831, 128,  128},
                                  {54,    32704, 32704, 32831, 32831, 128,  128},
                                  {55,    32704, 32704, 32767, 32895, 192,  64},
                                  {56,    32704, 32704, 32831, 32831, 128,  128},
                                  {57,    32576, 32512, 33023, 32959, 448,  448},
                                  {58,    32512, 32704, 32831, 33023, 320,  320},
                                  {59,    32640, 32768, 32767, 32895, 128,  128},
                                  {60,    32640, 32768, 32767, 32895, 128,  128},
                                  {61,    32640, 32768, 32767, 32895, 128,  128},
                                  {62,    32640, 32768, 32767, 32895, 128,  128},
                                  {63,    32576, 32640, 32895, 32959, 320,  320},
                                  {64,    32512, 32768, 32639, 32895, 128,  128},
                                  {65,    32704, 32768, 32831, 32895, 128,  128},
                                  {66,    32704, 32768, 32895, 32959, 192,  192},
                                  {67,    32640, 32704, 32831, 32895, 192,  192},
                                  {68,    32576, 32512, 33023, 32959, 448,  448},
                                  {69,    32512, 32704, 32831, 33023, 320,  320},
                                  {70,    32576, 32640, 33023, 33087, 448,  448},
                                  {72,    32704, 32768, 32895, 32895, 128,  192},
                                  {73,    32704, 32704, 32895, 32895, 192,  192},
                                  {74,    32704, 32768, 32895, 32959, 192,  192},
                                  {75,    32704, 32768, 32831, 32959, 192,  128},
                                  {76,    32704, 32768, 32831, 32895, 128,  128},
                                  {77,    32704, 32768, 32831, 32895, 128,  128},
                                  {78,    32832, 32704, 32959, 32831, 128,  128},
                                  {79,    32704, 32768, 32831, 32895, 128,  128},
                                  {80,    32704, 32768, 32831, 32895, 128,  128},
                                  {81,    32704, 32768, 32831, 32895, 128,  128},
                                  {82,    32640, 32768, 32767, 32895, 128,  128},
                                  {83,    32704, 32768, 32767, 32831, 64,   64},
                                  {84,    32704, 32768, 32767, 32831, 64,   64},
                                  {85,    32576, 32704, 32767, 32895, 192,  192},
                                  {86,    32768, 32704, 32959, 32895, 192,  192},
                                  {87,    32704, 32768, 32767, 32831, 64,   64},
                                  {88,    33472, 32704, 33535, 32767, 64,   64},
                                  {89,    32640, 32832, 32767, 32959, 128,  128},
                                  {90,    32640, 32832, 32767, 32959, 128,  128},
                                  {91,    32640, 32832, 32767, 32959, 128,  128},
                                  {92,    32640, 32832, 32767, 32959, 128,  128},
                                  {93,    32640, 32832, 32767, 32959, 128,  128},
                                  {94,    32640, 32832, 32767, 32959, 128,  128},
                                  {95,    32640, 32832, 32767, 32959, 128,  128},
                                  {96,    32640, 32832, 32767, 32959, 128,  128},
                                  {97,    32640, 32832, 32767, 32959, 128,  128},
                                  {98,    32640, 32832, 32767, 32959, 128,  128},
                                  {99,    32704, 32768, 32767, 32831, 64,   64},
                                  {101,   32704, 32704, 32895, 32895, 192,  192},
                                  {102,   32704, 32704, 32895, 32895, 192,  192},
                                  {103,   32704, 32704, 32895, 32895, 192,  192},
                                  {104,   32576, 32768, 32767, 32959, 192,  192},
                                  {105,   32576, 32768, 32767, 32959, 192,  192},
                                  {106,   33728, 32832, 33855, 32895, 64,   128},
                                  {107,   32576, 32768, 32767, 32959, 192,  192},
                                  {108,   32576, 32768, 32767, 32959, 192,  192},
                                  {109,   32576, 32768, 32767, 32959, 192,  192},
                                  {110,   32704, 32704, 32895, 32895, 192,  192},
                                  {111,   32576, 32768, 32767, 32959, 192,  192},
                                  {112,   32704, 32704, 32895, 32895, 192,  192},
                                  {113,   32704, 32704, 32895, 32895, 192,  192},
                                  {114,   32576, 32768, 32767, 32959, 192,  192},
                                  {115,   32576, 32768, 32767, 32959, 192,  192},
                                  {116,   32704, 32832, 32831, 32895, 64,   128},
                                  {117,   32576, 32768, 32767, 32959, 192,  192},
                                  {118,   32576, 32768, 32767, 32959, 192,  192},
                                  {119,   32576, 32768, 32767, 32959, 192,  192},
                                  {120,   32704, 32704, 32895, 32895, 192,  192},
                                  {121,   32576, 32768, 32767, 32959, 192,  192},
                                  {122,   32704, 32704, 32895, 32895, 192,  192},
                                  {123,   32704, 32704, 32895, 32895, 192,  192},
                                  {124,   32576, 32768, 32767, 32959, 192,  192},
                                  {125,   32576, 32768, 32767, 32959, 192,  192},
                                  {126,   32704, 32832, 32831, 32895, 64,   128},
                                  {127,   32576, 32768, 32767, 32959, 192,  192},
                                  {128,   32576, 32768, 32767, 32959, 192,  192},
                                  {129,   32576, 32768, 32767, 32959, 192,  192},
                                  {130,   32704, 32704, 32895, 32895, 192,  192},
                                  {131,   32576, 32768, 32767, 32959, 192,  192},
                                  {132,   32704, 32704, 32895, 32895, 192,  192},
                                  {133,   32704, 32704, 32895, 32895, 192,  192},
                                  {134,   32576, 32768, 32767, 32959, 192,  192},
                                  {135,   32576, 32768, 32767, 32959, 192,  192},
                                  {136,   32704, 32832, 32831, 32895, 64,   128},
                                  {137,   32576, 32768, 32767, 32959, 192,  192},
                                  {138,   32576, 32768, 32767, 32959, 192,  192},
                                  {139,   32576, 32768, 32767, 32959, 192,  192},
                                  {140,   32704, 32704, 32895, 32895, 192,  192},
                                  {141,   32576, 32768, 32767, 32959, 192,  192},
                                  {142,   32704, 32704, 32895, 32895, 192,  192},
                                  {143,   32704, 32704, 32895, 32895, 192,  192},
                                  {144,   32576, 32768, 32767, 32959, 192,  192},
                                  {145,   32576, 32768, 32767, 32959, 192,  192},
                                  {146,   32704, 32832, 32831, 32895, 64,   128},
                                  {147,   32576, 32768, 32767, 32959, 192,  192},
                                  {148,   32576, 32768, 32767, 32959, 192,  192},
                                  {149,   32576, 32768, 32767, 32959, 192,  192},
                                  {150,   32704, 32704, 32895, 32895, 192,  192},
                                  {151,   32576, 32768, 32767, 32959, 192,  192},
                                  {152,   32576, 32768, 32767, 32959, 192,  192},
                                  {153,   32576, 32768, 32767, 32959, 192,  192},
                                  {154,   32704, 32704, 32895, 32895, 192,  192},
                                  {155,   32704, 32704, 32895, 32895, 192,  192},
                                  {156,   32704, 32768, 32831, 32831, 64,   128},
                                  {157,   32576, 32768, 32767, 32959, 192,  192},
                                  {158,   32576, 32768, 32767, 32959, 192,  192},
                                  {159,   32576, 32768, 32767, 32959, 192,  192},
                                  {160,   32576, 32768, 32767, 32959, 192,  192},
                                  {161,   32576, 32768, 32767, 32959, 192,  192},
                                  {162,   32576, 32768, 32767, 32959, 192,  192},
                                  {163,   32576, 32768, 32767, 32959, 192,  192},
                                  {164,   32704, 32704, 32895, 32895, 192,  192},
                                  {165,   32704, 32704, 32895, 32895, 192,  192},
                                  {166,   32704, 32768, 32831, 32831, 64,   128},
                                  {167,   32576, 32768, 32767, 32959, 192,  192},
                                  {168,   32576, 32768, 32767, 32959, 192,  192},
                                  {169,   32576, 32768, 32767, 32959, 192,  192},
                                  {170,   32576, 32768, 32767, 32959, 192,  192},
                                  {171,   32576, 32768, 32767, 32959, 192,  192},
                                  {172,   32576, 32768, 32767, 32959, 192,  192},
                                  {173,   32576, 32768, 32767, 32959, 192,  192},
                                  {174,   32704, 32704, 32895, 32895, 192,  192},
                                  {175,   32704, 32704, 32895, 32895, 192,  192},
                                  {176,   32704, 32768, 32831, 32831, 64,   128},
                                  {177,   32576, 32768, 32767, 32959, 192,  192},
                                  {178,   32576, 32768, 32767, 32959, 192,  192},
                                  {179,   32576, 32768, 32767, 32959, 192,  192},
                                  {180,   32576, 32768, 32767, 32959, 192,  192},
                                  {181,   32576, 32768, 32767, 32959, 192,  192},
                                  {182,   32576, 32768, 32767, 32959, 192,  192},
                                  {183,   32576, 32768, 32767, 32959, 192,  192},
                                  {184,   32704, 32704, 32895, 32895, 192,  192},
                                  {185,   32704, 32704, 32895, 32895, 192,  192},
                                  {186,   32704, 32768, 32831, 32831, 64,   128},
                                  {187,   32576, 32768, 32767, 32959, 192,  192},
                                  {188,   32576, 32768, 32767, 32959, 192,  192},
                                  {189,   32576, 32768, 32767, 32959, 192,  192},
                                  {190,   32576, 32768, 32767, 32959, 192,  192},
                                  {191,   32576, 32768, 32767, 32959, 192,  192},
                                  {192,   32576, 32768, 32767, 32959, 192,  192},
                                  {193,   32576, 32768, 32767, 32959, 192,  192},
                                  {194,   32704, 32704, 32895, 32895, 192,  192},
                                  {195,   32704, 32704, 32895, 32895, 192,  192},
                                  {196,   32704, 32768, 32831, 32831, 64,   128},
                                  {197,   32576, 32768, 32767, 32959, 192,  192},
                                  {198,   32576, 32768, 32767, 32959, 192,  192},
                                  {199,   32576, 32768, 32767, 32959, 192,  192},
                                  {200,   32576, 32768, 32831, 33023, 256,  256},
                                  {201,   32768, 32768, 32959, 32959, 192,  192},
                                  {202,   32640, 32768, 32767, 32895, 128,  128},
                                  {203,   32640, 32768, 32767, 32895, 128,  128},
                                  {204,   32640, 32768, 32767, 32895, 128,  128},
                                  {205,   32640, 32768, 32767, 32895, 128,  128},
                                  {206,   32640, 32768, 32767, 32895, 128,  128},
                                  {207,   32640, 32768, 32767, 32895, 128,  128},
                                  {208,   32640, 32768, 32767, 32895, 128,  128},
                                  {209,   32640, 32768, 32767, 32895, 128,  128},
                                  {210,   32640, 32768, 32767, 32895, 128,  128},
                                  {211,   32640, 32768, 32767, 32895, 128,  128},
                                  {213,   32704, 32768, 32767, 32831, 64,   64},
                                  {217,   32640, 32768, 32767, 32831, 64,   128},
                                  {221,   32704, 32704, 32831, 32831, 128,  128},
                                  {237,   32704, 32768, 32767, 32831, 64,   64},
                                  {240,   32640, 33024, 32767, 33151, 128,  128},
                                  {241,   32704, 32832, 32831, 32959, 128,  128},
                                  {242,   32704, 32896, 32831, 33023, 128,  128},
                                  {243,   32640, 32832, 32767, 33023, 192,  128},
                                  {244,   32704, 32768, 33023, 33087, 320,  320},
                                  {248,   32704, 32768, 32831, 32895, 128,  128},
                                  {249,   32704, 32832, 32831, 32895, 64,   128},
                                  {250,   32704, 32768, 32831, 32895, 128,  128},
                                  {251,   32768, 32768, 32831, 32831, 64,   64},
                                  {252,   32576, 32832, 32767, 32895, 64,   192},
                                  {253,   32704, 32832, 32831, 33023, 192,  128},
                                  {254,   32576, 32768, 32767, 32959, 192,  192},
                                  {255,   32640, 32768, 32831, 32895, 128,  192},
                                  {256,   32640, 32768, 32895, 33023, 256,  256},
                                  {257,   32640, 32768, 32831, 32831, 64,   192},
                                  {258,   32640, 32768, 32831, 33151, 384,  192},
                                  {259,   32704, 32768, 32767, 32959, 192,  64},
                                  {300,   32832, 32448, 32959, 32639, 192,  128},
                                  {301,   32640, 32768, 32767, 32959, 192,  128},
                                  {302,   32704, 32832, 32767, 32895, 64,   64},
                                  {303,   32576, 32576, 32895, 32895, 320,  320},
                                  {304,   32576, 32768, 32959, 33023, 256,  384},
                                  {305,   32704, 32768, 32767, 32831, 64,   64},
                                  {306,   32512, 32768, 32767, 32959, 192,  256},
                                  {307,   32704, 32768, 32959, 32959, 192,  256},
                                  {308,   32704, 32768, 33023, 32959, 192,  320},
                                  {309,   32704, 32768, 33087, 32959, 192,  384},
                                  {310,   32704, 32768, 32895, 32959, 192,  192},
                                  {320,   32704, 32768, 33087, 33023, 256,  384},
                                  {330,   32704, 32832, 32767, 33023, 192,  64},
                                  {340,   32704, 32768, 32831, 32895, 128,  128},
                                  {350,   32640, 32768, 32767, 32895, 128,  128},
                                  {360,   32704, 32768, 32767, 32831, 64,   64},
                                  {370,   32704, 32768, 32767, 32831, 64,   64},
                                  {400,   32512, 32576, 33023, 33023, 448,  512},
                                  {401,   32704, 32768, 32831, 32895, 128,  128},
                                  {410,   32704, 32768, 32959, 33023, 256,  256},
                                  {420,   32704, 32832, 32831, 33087, 256,  128},
                                  {430,   32704, 32768, 32959, 33023, 256,  256},
                                  {440,   32256, 32768, 32767, 33279, 512,  512},
                                  {441,   32640, 32704, 32831, 32895, 192,  192},
                                  {442,   32704, 32704, 32895, 32895, 192,  192},
                                  {443,   32704, 32704, 32895, 32895, 192,  192},
                                  {444,   32704, 32768, 32767, 32831, 64,   64},
                                  {445,   32704, 32832, 32831, 32895, 64,   128},
                                  {446,   32704, 32768, 32767, 32831, 64,   64},
                                  {447,   32704, 32768, 32767, 32831, 64,   64},
                                  {450,   32640, 32768, 32831, 32959, 192,  192},
                                  {451,   32704, 32768, 32831, 32895, 128,  128},
                                  {452,   32704, 32768, 32831, 32895, 128,  128},
                                  {453,   32704, 32704, 32895, 32895, 192,  192},
                                  {454,   32704, 32768, 32831, 32895, 128,  128},
                                  {455,   32704, 32768, 32831, 32895, 128,  128},
                                  {456,   32704, 32768, 32831, 32895, 128,  128},
                                  {457,   32640, 32832, 32703, 32895, 64,   64},
                                  {460,   32704, 32768, 32831, 32895, 128,  128},
                                  {461,   32640, 32768, 32895, 32895, 128,  256},
                                  {462,   32640, 32768, 32831, 32895, 128,  192},
                                  {463,   32704, 32768, 32831, 32895, 128,  128},
                                  {464,   32704, 32768, 32831, 32895, 128,  128},
                                  {465,   32704, 32768, 32831, 32895, 128,  128},
                                  {466,   32704, 32768, 32831, 32895, 128,  128},
                                  {467,   32640, 32832, 32703, 32895, 64,   64},
                                  {468,   32640, 32832, 32703, 32895, 64,   64},
                                  {470,   32704, 32768, 32895, 32895, 128,  192},
                                  {471,   32704, 32768, 32831, 32895, 128,  128},
                                  {472,   32704, 32768, 32831, 32831, 64,   128},
                                  {473,   32704, 32768, 32959, 32895, 128,  256},
                                  {474,   32704, 32768, 32831, 32895, 128,  128},
                                  {475,   32640, 32768, 32831, 32895, 128,  192},
                                  {476,   32704, 32768, 32831, 32895, 128,  128},
                                  {477,   32704, 32768, 32831, 32895, 128,  128},
                                  {478,   32704, 32768, 32767, 32895, 128,  64},
                                  {480,   32640, 32768, 32895, 33023, 256,  256},
                                  {481,   32704, 32768, 32767, 32895, 128,  64},
                                  {482,   32640, 32704, 32831, 32895, 192,  192},
                                  {483,   32704, 32768, 32831, 32959, 192,  128},
                                  {484,   32704, 32768, 32831, 32895, 128,  128},
                                  {490,   32640, 32768, 32767, 32895, 128,  128},
                                  {491,   32640, 32704, 32767, 32895, 192,  128},
                                  {492,   32768, 32768, 32895, 32895, 128,  128},
                                  {493,   32704, 32704, 32831, 32831, 128,  128},
                                  {494,   32768, 32704, 32895, 32831, 128,  128},
                                  {495,   32704, 32768, 32831, 32895, 128,  128},
                                  {496,   32768, 32768, 32895, 32895, 128,  128},
                                  {500,   32704, 32768, 32767, 32831, 64,   64},
                                  {501,   32832, 32576, 32895, 32703, 128,  64},
                                  {502,   32832, 32576, 32895, 32703, 128,  64},
                                  {503,   32832, 32576, 32895, 32703, 128,  64},
                                  {504,   32832, 32576, 32895, 32703, 128,  64},
                                  {505,   32832, 32576, 32895, 32703, 128,  64},
                                  {506,   32832, 32576, 32895, 32703, 128,  64},
                                  {507,   32704, 32768, 33023, 32959, 192,  320},
                                  {508,   32768, 33088, 32895, 33215, 128,  128},
                                  {509,   32704, 32768, 32767, 32831, 64,   64},
                                  {511,   32832, 32576, 32895, 32703, 128,  64},
                                  {512,   32832, 32576, 32895, 32703, 128,  64},
                                  {513,   32832, 32576, 32895, 32703, 128,  64},
                                  {514,   32832, 32576, 32895, 32703, 128,  64},
                                  {515,   32832, 32576, 32895, 32703, 128,  64},
                                  {516,   32832, 32576, 32895, 32703, 128,  64},
                                  {521,   32640, 32896, 32767, 33023, 128,  128},
                                  {522,   32640, 32832, 32767, 32959, 128,  128},
                                  {523,   32640, 32832, 32767, 32959, 128,  128},
                                  {524,   32640, 32832, 32767, 32959, 128,  128},
                                  {530,   32704, 32768, 32895, 32895, 128,  192},
                                  {531,   32704, 32704, 32895, 32895, 192,  192},
                                  {532,   32704, 32768, 32895, 32895, 128,  192},
                                  {533,   32704, 32768, 32895, 32959, 192,  192},
                                  {534,   32704, 32768, 32959, 32895, 128,  256},
                                  {535,   32576, 32704, 32895, 33023, 320,  320},
                                  {536,   32704, 32768, 32767, 32831, 64,   64},
                                  {541,   32704, 32768, 32767, 32895, 128,  64},
                                  {542,   32704, 32768, 32767, 32895, 128,  64},
                                  {543,   32704, 32704, 32895, 32895, 192,  192},
                                  {550,   32384, 32640, 32895, 33151, 512,  512},
                                  {551,   32640, 32768, 32767, 32895, 128,  128},
                                  {552,   32704, 32768, 32767, 32895, 128,  64},
                                  {553,   32704, 32768, 32831, 32895, 128,  128},
                                  {554,   32704, 32768, 32831, 32895, 128,  128},
                                  {555,   32704, 32768, 32767, 32895, 128,  64},
                                  {556,   32704, 32768, 32831, 32895, 128,  128},
                                  {557,   32704, 32768, 32831, 32895, 128,  128},
                                  {558,   32704, 32768, 33215, 33279, 512,  512},
                                  {600,   32704, 32768, 32831, 32831, 64,   128},
                                  {601,   32704, 32768, 32895, 32895, 128,  192},
                                  {602,   32640, 32768, 32767, 32895, 128,  128},
                                  {603,   32640, 32768, 32767, 32895, 128,  128},
                                  {604,   32768, 32768, 32895, 32895, 128,  128},
                                  {605,   32768, 32768, 32895, 32895, 128,  128},
                                  {606,   32704, 32768, 32831, 32895, 128,  128},
                                  {607,   32704, 32768, 32831, 32895, 128,  128},
                                  {608,   32640, 32832, 32767, 32959, 128,  128},
                                  {610,   32704, 32768, 32831, 32895, 128,  128},
                                  {611,   32704, 32704, 32831, 32831, 128,  128},
                                  {612,   32704, 32768, 32831, 32895, 128,  128},
                                  {666,   32640, 32704, 32831, 32895, 192,  192},
                                  {701,   32640, 32576, 32959, 32895, 320,  320},
                                  {777,   32512, 32832, 32767, 33087, 256,  256},
                                  {778,   32704, 32640, 32959, 32959, 320,  256},
                                  {779,   32832, 32704, 32959, 32831, 128,  128},
                                  {780,   32576, 32704, 32831, 33087, 384,  256},
                                  {781,   32704, 32704, 33023, 32895, 192,  320},
                                  {782,   32704, 32768, 32831, 32895, 128,  128},
                                  {783,   32768, 32640, 33279, 32895, 256,  512},
                                  {784,   32704, 32768, 32831, 32895, 128,  128},
                                  {997,   32704, 32768, 32767, 32831, 64,   64},
                                  {998,   32704, 32768, 32767, 32831, 64,   64},
                                  {1000,  32704, 32768, 32895, 32959, 192,  192},
                                  {1001,  32704, 32768, 32895, 32959, 192,  192},
                                  {2000,  32704, 32832, 32895, 33023, 192,  192},
                                  {2001,  32640, 32704, 32831, 32895, 192,  192},
                                  {2002,  32704, 32768, 32831, 32895, 128,  128},
                                  {2003,  32704, 32768, 32895, 32959, 192,  192},
                                  {2004,  32704, 32768, 32895, 32895, 128,  192},
                                  {4941,  32768, 32704, 32895, 32831, 128,  128},
                                  {5001,  32704, 32704, 32831, 32831, 128,  128},
                                  {5002,  32704, 32704, 32831, 32831, 128,  128},
                                  {5003,  32704, 32704, 32831, 32831, 128,  128},
                                  {5004,  32704, 32704, 32831, 32831, 128,  128},
                                  {5005,  32704, 32704, 32831, 32831, 128,  128},
                                  {5006,  32704, 32704, 32831, 32831, 128,  128},
                                  {5007,  32704, 32704, 32831, 32831, 128,  128},
                                  {5008,  32704, 32704, 32831, 32831, 128,  128},
                                  {5009,  32704, 32704, 32831, 32831, 128,  128},
                                  {5010,  32704, 32704, 32831, 32831, 128,  128},
                                  {5011,  32704, 32704, 32831, 32831, 128,  128},
                                  {5012,  32704, 32704, 32831, 32831, 128,  128},
                                  {5013,  32704, 32704, 32831, 32831, 128,  128},
                                  {5014,  32704, 32704, 32831, 32831, 128,  128},
                                  {5015,  32704, 32704, 32831, 32831, 128,  128},
                                  {5016,  32704, 32704, 32831, 32831, 128,  128},
                                  {5017,  32704, 32704, 32831, 32831, 128,  128},
                                  {5018,  32704, 32704, 32831, 32831, 128,  128},
                                  {5019,  32704, 32704, 32831, 32831, 128,  128},
                                  {5020,  32704, 32704, 32831, 32831, 128,  128},
                                  {5021,  32704, 32704, 32831, 32831, 128,  128},
                                  {5022,  32704, 32704, 32831, 32831, 128,  128},
                                  {5023,  32704, 32704, 32831, 32831, 128,  128},
                                  {5024,  32704, 32704, 32831, 32831, 128,  128},
                                  {5025,  32704, 32704, 32831, 32831, 128,  128},
                                  {5026,  32704, 32704, 32831, 32831, 128,  128},
                                  {5027,  32704, 32704, 32831, 32831, 128,  128},
                                  {5028,  32704, 32704, 32831, 32831, 128,  128},
                                  {5029,  32704, 32704, 32831, 32831, 128,  128},
                                  {5030,  32704, 32704, 32831, 32831, 128,  128},
                                  {5031,  32704, 32704, 32831, 32831, 128,  128},
                                  {5032,  32704, 32704, 32831, 32831, 128,  128},
                                  {5033,  32704, 32704, 32831, 32831, 128,  128},
                                  {5034,  32704, 32704, 32831, 32831, 128,  128},
                                  {5035,  32704, 32704, 32831, 32831, 128,  128},
                                  {5036,  32704, 32704, 32831, 32831, 128,  128},
                                  {5037,  32704, 32704, 32831, 32831, 128,  128},
                                  {5038,  32704, 32704, 32831, 32831, 128,  128},
                                  {5039,  32704, 32704, 32831, 32831, 128,  128},
                                  {5040,  32704, 32704, 32831, 32831, 128,  128},
                                  {5041,  32704, 32704, 32831, 32831, 128,  128},
                                  {5042,  32704, 32704, 32831, 32831, 128,  128},
                                  {5043,  32704, 32704, 32831, 32831, 128,  128},
                                  {5044,  32704, 32704, 32831, 32831, 128,  128},
                                  {5045,  32704, 32704, 32831, 32831, 128,  128},
                                  {5046,  32704, 32704, 32831, 32831, 128,  128},
                                  {5047,  32704, 32704, 32831, 32831, 128,  128},
                                  {5048,  32704, 32704, 32831, 32831, 128,  128},
                                  {5049,  32704, 32704, 32831, 32831, 128,  128},
                                  {5050,  32704, 32704, 32831, 32831, 128,  128},
                                  {5051,  32704, 32704, 32831, 32831, 128,  128},
                                  {5052,  32704, 32704, 32831, 32831, 128,  128},
                                  {5053,  32704, 32704, 32831, 32831, 128,  128},
                                  {5054,  32704, 32704, 32831, 32831, 128,  128},
                                  {5055,  32704, 32704, 32831, 32831, 128,  128},
                                  {5056,  32704, 32704, 32831, 32831, 128,  128},
                                  {5057,  32704, 32704, 32831, 32831, 128,  128},
                                  {5058,  32704, 32704, 32831, 32831, 128,  128},
                                  {5059,  32704, 32704, 32831, 32831, 128,  128},
                                  {5060,  32704, 32704, 32831, 32831, 128,  128},
                                  {5061,  32704, 32704, 32831, 32831, 128,  128},
                                  {5062,  32704, 32704, 32831, 32831, 128,  128},
                                  {5063,  32704, 32704, 32831, 32831, 128,  128},
                                  {5064,  32704, 32704, 32831, 32831, 128,  128},
                                  {5065,  32704, 32704, 32831, 32831, 128,  128},
                                  {5066,  32704, 32704, 32831, 32831, 128,  128},
                                  {5067,  32704, 32704, 32831, 32831, 128,  128},
                                  {5068,  32704, 32768, 32831, 32895, 128,  128},
                                  {5069,  32704, 32768, 32831, 32895, 128,  128},
                                  {5070,  32704, 32768, 32831, 32895, 128,  128},
                                  {5071,  32704, 32768, 32831, 32895, 128,  128},
                                  {5072,  32704, 32768, 32831, 32895, 128,  128},
                                  {5073,  32704, 32768, 32831, 32895, 128,  128},
                                  {5074,  32704, 32768, 32831, 32895, 128,  128},
                                  {5075,  32704, 32768, 32831, 32895, 128,  128},
                                  {5076,  32704, 32768, 32831, 32895, 128,  128},
                                  {5077,  32704, 32768, 32831, 32895, 128,  128},
                                  {5078,  32704, 32768, 32831, 32895, 128,  128},
                                  {5079,  32704, 32768, 32831, 32895, 128,  128},
                                  {5080,  32704, 32768, 32831, 32895, 128,  128},
                                  {5081,  32704, 32768, 32831, 32895, 128,  128},
                                  {5082,  32704, 32768, 32831, 32895, 128,  128},
                                  {5083,  32704, 32768, 32831, 32895, 128,  128},
                                  {5084,  32704, 32768, 32831, 32895, 128,  128},
                                  {5085,  32704, 32768, 32831, 32895, 128,  128},
                                  {5086,  32704, 32768, 32831, 32895, 128,  128},
                                  {5087,  32704, 32768, 32831, 32895, 128,  128},
                                  {5088,  32704, 32768, 32831, 32895, 128,  128},
                                  {5089,  32704, 32768, 32831, 32895, 128,  128},
                                  {5090,  32704, 32768, 32831, 32895, 128,  128},
                                  {5091,  32704, 32768, 32831, 32895, 128,  128},
                                  {5092,  32704, 32768, 32831, 32895, 128,  128},
                                  {5093,  32704, 32768, 32831, 32895, 128,  128},
                                  {5094,  32704, 32768, 32831, 32895, 128,  128},
                                  {5095,  32704, 32768, 32831, 32895, 128,  128},
                                  {5096,  32704, 32768, 32831, 32895, 128,  128},
                                  {5097,  32704, 32768, 32831, 32895, 128,  128},
                                  {5098,  32704, 32768, 32831, 32895, 128,  128},
                                  {5099,  32704, 32768, 32831, 32895, 128,  128},
                                  {5100,  32704, 32768, 32831, 32895, 128,  128},
                                  {5101,  32704, 32768, 32831, 32895, 128,  128},
                                  {5102,  32704, 32768, 32831, 32895, 128,  128},
                                  {5103,  32704, 32768, 32831, 32895, 128,  128},
                                  {5104,  32704, 32768, 32831, 32895, 128,  128},
                                  {5105,  32704, 32768, 32831, 32895, 128,  128},
                                  {5106,  32704, 32768, 32831, 32895, 128,  128},
                                  {5107,  32704, 32768, 32831, 32895, 128,  128},
                                  {5108,  32704, 32768, 32831, 32895, 128,  128},
                                  {5109,  32704, 32768, 32831, 32895, 128,  128},
                                  {5110,  32704, 32768, 32831, 32895, 128,  128},
                                  {5111,  32704, 32768, 32831, 32895, 128,  128},
                                  {5112,  32704, 32768, 32831, 32895, 128,  128},
                                  {5113,  32704, 32768, 32831, 32895, 128,  128},
                                  {5114,  32704, 32768, 32831, 32895, 128,  128},
                                  {5115,  32704, 32768, 32831, 32895, 128,  128},
                                  {5116,  32704, 32768, 32831, 32895, 128,  128},
                                  {5117,  32704, 32768, 32831, 32895, 128,  128},
                                  {5118,  32704, 32768, 32831, 32895, 128,  128},
                                  {5119,  32704, 32768, 32831, 32895, 128,  128},
                                  {5120,  32704, 32768, 32831, 32895, 128,  128},
                                  {5121,  32704, 32768, 32831, 32895, 128,  128},
                                  {5122,  32704, 32768, 32831, 32895, 128,  128},
                                  {5123,  32704, 32768, 32831, 32895, 128,  128},
                                  {5124,  32768, 32768, 32831, 32831, 64,   64},
                                  {5125,  32768, 32832, 32831, 32895, 64,   64},
                                  {5131,  32768, 32832, 32831, 32895, 64,   64},
                                  {5132,  32768, 32832, 32831, 32895, 64,   64},
                                  {5133,  32768, 32832, 32831, 32895, 64,   64},
                                  {5134,  32768, 32832, 32831, 32895, 64,   64},
                                  {5140,  32704, 32768, 32895, 32895, 128,  192},
                                  {5701,  32576, 32512, 33023, 32959, 448,  448},
                                  {5801,  32512, 32704, 32831, 33023, 320,  320},
                                  {5802,  32512, 32704, 32831, 33023, 320,  320},
                                  {5803,  32512, 32704, 32831, 33023, 320,  320},
                                  {5804,  32512, 32704, 32831, 33023, 320,  320},
                                  {5805,  32512, 32704, 32831, 33023, 320,  320},
                                  {7000,  32640, 32576, 32959, 32895, 320,  320},
                                  {7001,  32640, 32704, 32831, 32895, 192,  192},
                                  {7002,  32512, 32512, 32767, 32767, 256,  256},
                                  {7003,  32512, 32512, 32767, 32767, 256,  256},
                                  {7004,  32512, 32512, 32767, 32767, 256,  256},
                                  {7005,  32512, 32512, 32767, 32767, 256,  256},
                                  {7006,  32512, 32512, 32767, 32767, 256,  256},
                                  {7007,  32704, 32768, 32895, 32959, 192,  192},
                                  {7008,  32704, 32768, 32895, 32959, 192,  192},
                                  {7009,  32704, 32768, 32895, 32959, 192,  192},
                                  {7010,  32704, 32768, 32895, 32959, 192,  192},
                                  {7011,  32704, 32768, 32895, 32959, 192,  192},
                                  {7051,  32640, 32576, 32959, 32895, 320,  320},
                                  {7052,  32640, 32576, 32959, 32895, 320,  320},
                                  {7053,  32640, 32576, 32959, 32895, 320,  320},
                                  {7054,  32640, 32576, 32959, 32895, 320,  320},
                                  {7055,  32640, 32576, 32959, 32895, 320,  320},
                                  {8011,  32768, 32768, 32895, 32895, 128,  128},
                                  {8012,  32704, 32704, 32895, 32895, 192,  192},
                                  {8013,  32704, 32768, 32767, 32831, 64,   64},
                                  {8014,  32704, 32704, 32767, 32831, 128,  64},
                                  {8015,  32704, 32704, 32831, 32831, 128,  128},
                                  {16384, 32704, 32768, 32767, 32831, 64,   64},
                                  {16896, 32704, 32768, 32767, 32831, 64,   64},
                                  {17408, 32704, 32768, 32767, 32831, 64,   64},
                                  {17920, 32704, 32768, 32767, 32831, 64,   64},
                                  {18432, 32704, 32768, 32767, 32831, 64,   64},
                                  {18944, 32704, 32768, 32767, 32831, 64,   64},
                                  {19456, 32704, 32768, 32767, 32831, 64,   64},
                                  {19968, 32704, 32768, 32767, 32831, 64,   64},
                                  {20480, 32704, 32768, 32767, 32831, 64,   64},
                                  {20992, 32704, 32768, 32767, 32831, 64,   64},
                                  {21504, 32704, 32768, 32767, 32831, 64,   64},
                                  {22016, 32704, 32768, 32767, 32831, 64,   64},
                                  {22528, 32704, 32768, 32767, 32831, 64,   64},
                                  {23040, 32704, 32768, 32767, 32831, 64,   64},
                                  {23552, 32704, 32768, 32767, 32831, 64,   64},
                                  {24064, 32704, 32768, 32767, 32831, 64,   64},
                                  {24576, 32704, 32768, 32767, 32831, 64,   64},
                                  {25088, 32704, 32768, 32767, 32831, 64,   64}};
static const int MAP_INFO_SIZE = sizeof(MAP_INFO) / sizeof(MAP_INFO[0]); // 地图总数
static const int NUMS_OF_THREAD = MAP_INFO_SIZE / FILES_PER_THREAD + 1; // 读取线程总数

SINGLETON_INIT(WorldMap)

MapReader::MapReader(int rindex) :
        rindex_(rindex) {
}

void MapReader::run() {
    Application &app = Application::instance();
    WorldMap &wm = WorldMap::getSingleton();
    for (int i = rindex_; i < MAP_INFO_SIZE; i += NUMS_OF_THREAD) {
        int id = MAP_INFO[i][MAP_ID];

        try {
            Map &map = wm.maps_[id];
            map.id = id;
            map.leftTop.x = MAP_INFO[i][START_X];
            map.rightBottom.x = MAP_INFO[i][END_X];
            map.leftTop.y = MAP_INFO[i][START_Y];
            map.rightBottom.y = MAP_INFO[i][END_Y];
            map.width = MAP_INFO[i][WIDTH];
            map.height = MAP_INFO[i][HEIGHT];
            map.tiles.reserve(MAP_INFO[i][WIDTH * HEIGHT]);

            // 获取地图地形信息
            std::ifstream ifs(Poco::format("%s/%d.txt", mapFilePath, id).c_str());
            if (!ifs) {
                app.logger().error(Poco::format("%s.txt open failed!", id));
                return;
            }
            for (std::string line; std::getline(ifs, line);) {
                if (line.front() == '#' || line.empty())
                    continue;

                for (size_t i = 0; i < line.length(); i++) {
                    if (line[i] == ',')
                        continue;
                    map.tiles.emplace_back(line[i]);
                }
            }
            if (!ifs.eof()) {
                app.logger().error(Poco::format("%s.txt getline failed(%s)!", id, ifs.rdstate()));
                return;
            }

            // 保存地图信息对象
            wm.maps_[id] = map;
        }
        catch (std::ifstream::failure &e) {
            app.logger().error(Poco::format("%s.txt process failed(%s)!", id, e.what()));
        }
    }
}

bool WorldMap::initialize(LayeredConfiguration &cfg) {
    mapFilePath = cfg.getString("Server.map_file_path", "~/maps");

    // 强制从数据库加载或者反序列化失败
    if (cfg.getBool("Server.force_db", false) || !loadCache()) {
        // 从数据库构建对象
        if (!loadDB()) {
            return false;
        }

        // 对象序列化
        if (!buildCache()) {
            return false;
        }
    }

    return true;
}

Map& WorldMap::operator[](int id) {
    static Map none;
    auto iter = maps_.find(id);
    if (iter != maps_.end()) {
        return iter->second;
    } else {
        return none;
    }
}

bool WorldMap::buildCache() {
    Application &app = Application::instance();
    try {
        std::ofstream ofs(cacheFile);
        boost::archive::binary_oarchive oa(ofs);
        oa << maps_;
        return true;
    } catch (const boost::archive::archive_exception &e) {
        app.logger().error(e.what());
    }
    return false;
}

bool WorldMap::loadCache() {
    Application &app = Application::instance();
    try {
        std::ifstream ifs(cacheFile);
        boost::archive::binary_iarchive ia(ifs);
        ia >> maps_;
        return true;
    } catch (const boost::archive::archive_exception &e) {
        app.logger().error(e.what());
    }
    return false;
}

bool WorldMap::loadDB() {
    Application &app = Application::instance();

    // 多线程读取地图数据
    std::vector<MapReader> readers;
    for (int i = 0; i < NUMS_OF_THREAD; i++)
        readers.emplace_back(i);
    ThreadPool tp(NUMS_OF_THREAD, NUMS_OF_THREAD);
    for (auto reader : readers)
        tp.start(reader);
    tp.joinAll();
    assert(maps_.size() == MAP_INFO_SIZE);

    // 读取数据库配置
    try {
        Session ses(Storage::getSingleton().get());

        Statement select(ses);
        select << "SELECT mapid, locationname, startX, endX, startY, endY, monster_amount, "
                  "drop_rate, underwater, markable, teleportable, escapable, resurrection, "
                  "painwand, penalty, take_pets, recall_pets, usable_item, usable_skill, arena FROM mapids", now;
        RecordSet rs(select);
        for (auto iter = rs.begin(); iter != rs.end(); iter++) {
            std::size_t col = 0;
            int id = iter->get(col++).convert<int>();
            auto value = maps_.find(id);
            if (value == maps_.end()) {
                app.logger().error(Poco::format("invalid map(%d)!", id));
                return false;
            }
            Map &map = value->second;
            map.name = iter->get(col++).convert<std::string>();
            assert(map.leftTop.x == iter->get(col).convert<int>());
            col++;
            assert(map.rightBottom.x == iter->get(col).convert<int>());
            col++;
            assert(map.leftTop.y == iter->get(col).convert<int>());
            col++;
            assert(map.rightBottom.y == iter->get(col).convert<int>());
            col++;
            map.monsterAmount = iter->get(col++).convert<double>();
            map.dropRate = iter->get(col++).convert<double>();
            map.isUnderwater = iter->get(col++).convert<bool>();
            map.isMarkable = iter->get(col++).convert<bool>();
            map.isTeleportable = iter->get(col++).convert<bool>();
            map.isEscapable = iter->get(col++).convert<bool>();
            map.isUseResurrection = iter->get(col++).convert<bool>();
            map.isUsePainwand = iter->get(col++).convert<bool>();
            map.isEnabledDeathPenalty = iter->get(col++).convert<bool>();
            map.isTakePets = iter->get(col++).convert<bool>();
            map.isRecallPets = iter->get(col++).convert<bool>();
            map.isUsableItem = iter->get(col++).convert<bool>();
            map.isUsableSkill = iter->get(col++).convert<bool>();
            map.isArena = iter->get(col++).convert<bool>();
        }

        return true;
    } catch (const RangeException &e) {
        app.logger().error(e.name());
    } catch (const NotImplementedException &e) {
        app.logger().error(e.name());
    } catch (const DataException &e) {
        app.logger().error(e.name());
    }
    return false;
}

}
